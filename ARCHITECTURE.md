# 智能新风系统主机 - 架构设计文档

> **版本**: v1.0  
> **更新日期**: 2025-12-09  
> **目标读者**: 架构师、高级开发者、AI 助手

---

## 📚 目录

- [系统架构总览](#系统架构总览)
- [软件分层设计](#软件分层设计)
- [核心模块详解](#核心模块详解)
- [通信协议](#通信协议)
- [数据流设计](#数据流设计)

---

## 🏗️ 系统架构总览

### 系统拓扑

```
┌─────────────────────────────────────────────────────────┐
│                    云端 (OneNET)                        │
└───────────────────────────┬─────────────────────────────┘
                            │ MQTT
                            ▼
┌─────────────────────────────────────────────────────────┐
│                 中央控制主机 (Host)                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  HMI    │  │ ESP8266 │  │ Zigbee  │  │ Sensors │    │
│  │ 触摸屏  │  │  WiFi   │  │ 协调器  │  │ 传感器  │    │
│  └─────────┘  └─────────┘  └────┬────┘  └─────────┘    │
│                                 │                       │
│         MCU: HT32F52352         │                       │
└─────────────────────────────────┼───────────────────────┘
                                  │ Zigbee 无线
        ┌─────────────────────────┼─────────────────────────┐
        ▼                         ▼                         ▼
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   从机 1      │       │   从机 2      │       │   从机 3      │
│  STM32F103    │       │  STM32F103    │       │  STM32F103    │
│  风扇+传感器  │       │  风扇+传感器  │       │  风扇+传感器  │
└───────────────┘       └───────────────┘       └───────────────┘
```

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **MCU** | HT32F52352 | ARM Cortex-M0+, 48MHz |
| **通信** | UART / Zigbee / WiFi | 多通道通信 |
| **调度** | 前后台 + 任务调度器 | 非抢占式 |
| **协议** | MQTT / 自定义协议 | 云端/本地通信 |

---

## 📐 软件分层设计

```
┌────────────────────────────────────────┐
│            应用层 (Application)         │
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ 任务调度 │  │ IAQ算法  │  │ 通信管理││
│  └──────────┘  └──────────┘  └────────┘│
├────────────────────────────────────────┤
│            驱动层 (Driver)              │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌──────┐│
│  │ UART  │ │ GPIO  │ │ Timer │ │ ADC  ││
│  └───────┘ └───────┘ └───────┘ └──────┘│
├────────────────────────────────────────┤
│            硬件层 (Hardware)            │
│        MCU + 外设 + 传感器              │
└────────────────────────────────────────┘
```

### 1. 应用层

**职责**: 业务逻辑、任务调度、算法决策

| 模块 | 文件 | 功能 |
|------|------|------|
| 任务调度器 | `Task_Scheduler.c` | 周期性任务执行 |
| IAQ 算法 | `iaq_algorithm.c` | 空气质量决策 |
| 全局数据 | `app_globals.c` | 系统状态管理 |

### 2. 驱动层

**职责**: 硬件抽象、外设控制

| 模块 | 路径 | 功能 |
|------|------|------|
| ESP8266 | `Hardware/ESP8266/` | WiFi 通信 |
| Zigbee | `Hardware/Zigbee/` | 从机通信 |
| HMI | `Hardware/HMI/` | 串口屏驱动 |
| 传感器 | `Hardware/DHT11/` 等 | 数据采集 |

### 3. 硬件层

**职责**: 底层寄存器操作、芯片库

- `Library/` - 芯片标准库
- `System/` - 系统配置

---

## 🎯 核心模块详解

### 1. 任务调度器

**文件**: `Code/Task_Scheduler.c`

**设计模式**: 基于 SysTick 的非抢占式调度

```c
// 任务标志结构
typedef struct {
    uint8_t run_task_sensor_read;      // 每 1s
    uint8_t run_task_upload_data;      // 每 5s
    uint8_t run_task_intelligent_control; // 每 5s
    // ...
} TaskFlags_t;

// 调度器工作流程
// 1. SysTick_Handler 中调用 Scheduler_Tick()
// 2. Scheduler_Tick() 累加计数器，置位任务标志
// 3. main 循环中调用 Scheduler_Run()
// 4. Scheduler_Run() 检查标志，执行对应任务
```

### 2. IAQ 智能算法

**文件**: `Code/iaq_algorithm.c`

**算法流程**:

```
┌──────────────────────────────────────────────────────┐
│              IAQ 智能决策算法                         │
├──────────────────────────────────────────────────────┤
│  1. 读取传感器数据 (PM2.5, CO, 烟雾, VOCs, 温湿度)   │
│                      ▼                               │
│  2. 归一化处理 (原始值 → 0-10 分)                    │
│                      ▼                               │
│  3. 加权计算 IAQ Score                               │
│     Score = Σ(Sensor_Score × Weight)                 │
│                      ▼                               │
│  4. 计算区域所需转速 (0-100%)                        │
│                      ▼                               │
│  5. 全局联动决策                                     │
│     Final_Speed = MAX(local_speed, global_speed)     │
└──────────────────────────────────────────────────────┘
```

**权重配置**:

| 传感器 | 权重 | 说明 |
|--------|------|------|
| CO | 10 | 最高，急性安全威胁 |
| 烟雾 | 8 | 次高，火灾风险 |
| PM2.5 | 5 | 中，慢性健康威胁 |
| VOCs | 4 | 中，综合污染 |
| 温湿度 | 2 | 低，舒适度调节 |

### 3. 全局数据结构

**文件**: `Code/app_globals.c`

```c
typedef struct {
    // 主机数据
    struct {
        float temperature;
        float humidity;
        uint16_t pm25;
        uint16_t smoke;
    } host_sensors;
    
    // 从机数据 (x3)
    struct {
        float temperature;
        float humidity;
        uint16_t co;
        uint16_t voc;
        uint8_t fan_speed;
    } slaves[3];
    
    // 系统状态
    uint8_t wifi_connected;
    uint8_t zigbee_online[3];
} SystemData_t;

extern SystemData_t g_system_data;
```

---

## 📡 通信协议

### Zigbee 通信协议

**帧格式**:

```
┌──────┬──────┬──────┬──────────┬──────┐
│ 帧头 │ 地址 │ 命令 │ 数据     │ 校验 │
│ 0xAA │ 1B   │ 1B   │ N Bytes  │ 1B   │
└──────┴──────┴──────┴──────────┴──────┘
```

**命令表**:

| 命令 | 代码 | 方向 | 说明 |
|------|------|------|------|
| 心跳 | 0x01 | 主→从 | 检测从机在线 |
| 数据上报 | 0x02 | 从→主 | 从机上报传感器数据 |
| 风扇控制 | 0x03 | 主→从 | 下发风扇转速 |
| 状态查询 | 0x04 | 主→从 | 查询从机状态 |

### MQTT 通信

**Topic 设计**:

```
devices/{device_id}/upload    # 数据上报
devices/{device_id}/command   # 下行命令
```

---

## 💾 数据流设计

### 数据采集流

```
传感器 → 驱动读取 → g_system_data → 任务使用
```

### 决策控制流

```
g_system_data → IAQ算法 → target_speed → Zigbee发送 → 从机执行
```

### 数据上报流

```
g_system_data → JSON打包 → ESP8266 → MQTT → OneNET云
```

---

**更新时间**: 2025-12-09
