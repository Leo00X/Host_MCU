# 基于物联网的多节点联动式智能新风系统 - 中央控制主机 (Host)

本项目是“基于物联网的多节点联动式家用智能新风系统”的中央控制主机（Master）部分。

中央控制主机是整个系统的指挥中心，采用高性能的`HT32F52367`单片机作为核心。它对内作为Zigbee网络协调器管理所有从机节点；对外通过`ESP8266` Wi-Fi模块连接`OneNET`云平台，承担物联网网关的职责；在本地，它驱动HMI触摸屏，实现对系统状态的全面监测与直接控制 。

## 系统架构

本系统采用“主从式”分布式网络架构。中央控制主机 (Master) 作为Zigbee网络协调器，负责管理三个基于`STM32`的分布式新风从机 (Slaves) 。

* **主机 (Host):** 不带风扇。负责收集所有数据、运行全局算法、连接云和HMI。
* **从机 (Slave) x3:** 带风扇。负责采集各自区域数据，并执行主机下发的风扇控制指令。

## 核心功能

* **物联网网关：** 通过`ESP8266` Wi-Fi模块接入互联网，运用`MQTT`协议将系统关键数据（如各区域环境参数、风机状态）实时上传至`ONENET`云平台 。
* **远程监控：** 支持使用`HBuilder X`开发的手机APP，实现对整个新风系统的远程实时监控和手动干预 。
* **本地HMI交互：** 驱动`淘晶驰T1系列3.5寸串口HMI触摸屏`，通过自主设计的UI界面，实现对全部节点（主机与各个从机）状态的全面监测与直接控制 。
* **中央环境监测：** 自身集成了`DHT11`、`MQ2`、`PM2.5`等多种传感器，用于监测中央区域的环境状况，为系统决策提供关键数据 。
* **Zigbee网络协调：** 作为Zigbee网络协调器，负责构建和管理与所有从机节点之间的低功耗、高可靠性的无线自组网 。

---

## 核心功能：智能联动决策算法 (IAQ)

**这是本项目的智能化核心。** 我们没有使用简单的阈值开关，而是实现了一个“基于权重和阈值的综合空气质量指数 (IAQ) 算法”，该算法被独立封装在 `iaq_algorithm.c` 模块中。

### 1. 算法目标
主机的决策算法需要实时“权衡”来自4个不同区域（1个主机区 + 3个从机区）的所有传感器数据（PM2.5, CO, 烟雾, VOCs, 温湿度），并计算出3个从机风扇的“差异化”转速。

### 2. 算法逻辑 (IAQ 权重指数法)

**A. 设定权重 (权衡):**
为不同传感器的危险程度设定不同权重。
* `W_CO` (CO): 10 (最高, 急性安全威胁, 来自从机)
* `W_SMOKE` (烟雾): 8 (次高, 火灾风险, 主机与从机均有)
* `W_PM25` (PM2.5): 5 (中, 慢性健康威胁, 来自主机)
* `W_VOC` (空气质量): 4 (中, 综合污染, 来自从机)
* `W_TEMP` / `W_HUMI`: 2 (低, 舒适度调节, 主机与从机均有)

**B. 归一化 (评分):**
将每个传感器的原始读数 (ppm, μg/m³) 通过 `_Normalize_...()` 系列函数，转换为统一的“污染/不舒适评分”（例如 0-10 分）。

**C. 计算“综合污染指数” (IAQ Score):**
主机对4个区域（1个主机 + 3个从机）**独立**进行计算：
`IAQ_Score = (Score_CO * W_CO) + (Score_PM25 * W_PM25) + ...`

**D. 计算“区域所需转速”:**
根据 `IAQ_Score` 决策该区域“需要”的风扇转速（0% - 100%）。
* `speed_required_host` = 主机区域所需的转速 (基于主机的 PM2.5, 烟雾, 温湿度)
* `speed_required_slave[i]` = 从机 `i` 区域所需的转速 (基于从机的 CO, 烟雾, VOCs, 温湿度)

**E. 全局联动决策 (核心):**
主机**没有风扇**，它的PM2.5数据用于全局控制。最终下发给每个从机的指令是**两者中的最大值**：

`Final_Speed_Slave[i] = MAX( speed_required_slave[i], speed_required_host )`

* **场景1 (局部污染):** 从机1的CO超标，`speed_required_slave[1]`为`100%`。主机PM2.5正常，`speed_required_host`为`0%`。最终从机1风扇转速为 `MAX(100, 0) = 100%`。
* **场景2 (全局污染):** 所有从机区域空气良好，`speed_required_slave`均为`0%`。但主机PM2.5爆表，`speed_required_host`为`100%`。最终所有从机风扇转速均为 `MAX(0, 100) = 100%`。

---

## 硬件规格 (Host)

| 组件 | 型号/规格 | 备注 |
| :--- | :--- | :--- |
| 核心MCU | `HT32F52367` (BM53A367A 开发板) | 系统主控 |
| Wi-Fi模块 | `ESP8266` | 连接OneNET云平台 |
| Zigbee模块 | `E18-MS1-PCB` (亿佰特CC2530) | 首选方案，用于与从机组网 |
| HMI触控屏 | 淘晶驰T1系列 3.5寸串口屏 (TJC4832T135011) | 本地人机交互界面 |
| 温湿度传感器 | `DHT11` | 监测主机区域环境 |
| 烟雾传感器 | `MQ2` | 监测主机区域环境 |
| PM2.5传感器 | `DC01` (红外) | 监测主机区域环境 (关键决策数据) |
| 蜂鸣器 | 有源蜂鸣器 | 报警提示 |
| 供电 | `Type-C` 供电 | |

*(注：`MQ7` CO传感器位于从机端，用于监测局部CO浓度)*

## 软件功能实现

主机固件采用基于`SysTick`的“前后台”任务调度器（非抢占式），实现了高度模块化的软件架构。

### 1. 软件架构

* `app_globals.c` / `.h`: **“数据大脑”**。定义并初始化全局唯一的 `SystemData_t g_system_data` 结构体，存储所有主机和从机的实时状态与数据。
* `Task_Scheduler.c` / `.h`: **“行动中心”**。实现一个 `tick-based` 调度器。`Scheduler_Tick()` 在 `SysTick_Handler` 中被调用，用于设置任务标志；`Scheduler_Run()` 在 `main` 循环中被调用，用于执行被标记的任务。
* `iaq_algorithm.c` / `.h`: **“决策大脑”**。**（本次新增）** 独立的智能决策模块，负责实现上述的“IAQ权重算法”。它与任务调度器完全解耦，仅通过读写 `g_system_data` 来与系统交互。

### 2. 任务执行流程

1.  `SysTick_Handler` 周期性调用 `Scheduler_Tick()`。
2.  `Scheduler_Tick()` 按设定的时间（如每5秒）将 `g_task_flags.run_task_intelligent_control` 置为 `true`。
3.  `main()` 循环中的 `Scheduler_Run()` 检测到该标志，执行 `_Task_IntelligentControl()`。
4.  `_Task_IntelligentControl()` **只做一件事**：调用 `IAQ_RunDecisionAlgorithm()`。
5.  `IAQ_RunDecisionAlgorithm()` 函数执行完整的“全局联动决策”：
    * 从 `g_system_data` 读取所有（4个区域）传感器的值。
    * 执行“权重 -> 归一化 -> 算分 -> `MAX()`决策”逻辑。
    * 将最终的3个风扇转速（0-100%）写回 `g_system_data.slaves[i].control.target_fan_speed`。
6.  另一个任务 `_Task_CommandDispatch`（每500ms运行）会自动检测到 `target_fan_speed` 的变化，并立即将新指令通过 Zigbee 发送给对应的从机。

### 3. 无线通信
* **Zigbee组网：** 通过`E18-MS1-PCB`（首选）或`DL-20`（备选）Zigbee模块构建无线网络，实现主机与从机之间稳定可靠的数据交互。
* **自定义协议：** 采用自定义的通信协议进行节点间的数据交换。

### 4. 物联网 (IoT) 功能
* **云端连接：** 主机集成`ESP8266` Wi-Fi模块接入互联网。
* **MQTT通信：** 运用`MQTT`协议将系统关键数据（各区域环境参数、风机状态）实时上传至`ONENET`云平台。
* **APP远程控制：** 用户能够通过手机APP端（HBuilder X编写）远程查看系统实时状态，并可以手动下发控制指令。

### 5. HMI触控屏交互
* **串口通信：** 主机使用串口与HMI串口屏通信。
* **UI设计：** 自主设计UI界面，用于展示全部环境参数（主机、各个从机）、各个新风机运行状况。
* **本地控制：** 可通过触摸屏直接控制新风系统的运行模块。
