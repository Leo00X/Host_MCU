# Keil5 嵌入式开发 Bug 防范指南

> **目的**: 记录常见易错模式，避免重复踩坑
> **更新时间**: 2025-12-09

---

## 🎯 快速决策树

```
发现 BUG
  └─→ 硬件问题？
      ├─→ 是 → 检查接线、供电、信号
      └─→ 否 → 软件问题？
          ├─→ 初始化 → 时钟、GPIO、外设顺序
          ├─→ 通信 → 波特率、协议、时序
          ├─→ 中断 → 优先级、标志清除、临界区
          └─→ 数据 → 类型溢出、指针、边界
```

---

## 📋 易错案例

### Case 1: 时钟未使能

**现象**: 外设初始化后不工作

**错误代码**:
```c
GPIO_Init(GPIOA, &GPIO_InitStruct);  // 直接初始化
```

**正确代码**:
```c
RCC_AHBPeriphClockCmd(RCC_AHBPeriph_GPIOA, ENABLE);  // 先使能时钟
GPIO_Init(GPIOA, &GPIO_InitStruct);
```

---

### Case 2: 中断标志未清除

**现象**: 中断只触发一次

**错误代码**:
```c
void EXTI_IRQHandler(void) {
    // 处理中断
    DoSomething();
}
```

**正确代码**:
```c
void EXTI_IRQHandler(void) {
    if (EXTI_GetITStatus(EXTI_Line0) != RESET) {
        DoSomething();
        EXTI_ClearITPendingBit(EXTI_Line0);  // 清除标志
    }
}
```

---

### Case 3: 变量类型溢出

**现象**: 计数器到 255 后归零

**错误代码**:
```c
uint8_t counter = 0;
counter += 300;  // 溢出！
```

**正确代码**:
```c
uint16_t counter = 0;
counter += 300;  // 正常
```

---

### Case 4: 中断中操作共享变量

**现象**: 数据偶尔错误

**错误代码**:
```c
// 主循环
counter++;

// 中断
void IRQHandler(void) {
    counter++;  // 竞态条件！
}
```

**正确代码**:
```c
// 主循环
__disable_irq();
counter++;
__enable_irq();
```

---

### Case 5: 串口波特率错误

**现象**: 收发乱码

**检查项**:
- 系统时钟频率是否正确
- 波特率计算是否正确
- 发送/接收方波特率是否一致

---

### Case 6: I2C 地址错误

**现象**: 设备无响应

**检查项**:
- 7位地址 vs 8位地址
- 是否需要左移
- 上拉电阻是否配置

---

### Case 7: 延时不准确

**现象**: 时序不符合预期

**错误代码**:
```c
for (int i = 0; i < 1000000; i++);  // 不可靠
```

**正确代码**:
```c
SysTick_DelayMs(100);  // 使用定时器
```

---

### Case 8: 指针未初始化

**现象**: 程序跑飞

**错误代码**:
```c
uint8_t *ptr;
*ptr = 0x55;  // 野指针！
```

**正确代码**:
```c
uint8_t data;
uint8_t *ptr = &data;
*ptr = 0x55;
```

---

## ✅ 开发检查清单

### 编译前
- [ ] 变量类型是否合适
- [ ] 指针是否初始化
- [ ] 数组是否越界

### 初始化
- [ ] 时钟是否使能
- [ ] GPIO 是否配置
- [ ] 初始化顺序是否正确

### 中断
- [ ] 优先级是否合理
- [ ] 标志是否清除
- [ ] 临界区是否保护

### 通信
- [ ] 波特率是否正确
- [ ] 协议是否匹配
- [ ] 时序是否满足

---

**更新时间**: 2025-12-09
